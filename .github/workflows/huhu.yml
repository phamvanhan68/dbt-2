name: Python CI

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug
      tags:
        description: 'Test scenario tags'
        required: false
        type: boolean
      environment:
        description: 'Environment to run tests against'
        type: environment
        required: true
  pull_request:

env:
  KEY_FILE: /home/runner/work/dbt-2/dbt-2/.github/workflows/dbt_service_account.json

jobs:
  build:
    runs-on: ubuntu-latest


    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-cloud-bigquery

    - name: Set up Google Cloud credentials
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      shell: bash
      run: "echo $GOOGLE_APPLICATION_CREDENTIALS > $KEY_FILE"

    - name: Run Python script
      env:
        DATASET_NAME: ${{ format('inquirer_dbt_pr_{0}', github.event.pull_request.number ) }}
        PROJECT_ID: iron-burner-394207
        CREDENTIAL_FILE: ${{ env.KEY_FILE }}
      run: |
        python - <<EOF
        from google.cloud import bigquery
        from google.oauth2 import service_account
        import os

        credentials_file = os.environ['CREDENTIAL_FILE']
        credentials = service_account.Credentials.from_service_account_file(credentials_file)
        client = bigquery.Client(credentials=credentials, project=os.environ['PROJECT_ID'])

        print("Dataset from ENV: {}".format(os.environ['DATASET_NAME']))

        dataset_id = 'testing_01'
        response = client.delete_dataset(
          dataset_id, delete_contents=True, not_found_ok=True
        )

        print("Deleted dataset '{}'.".format(dataset_id))
        EOF